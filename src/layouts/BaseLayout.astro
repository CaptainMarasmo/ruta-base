---
import es from "../i18n/es.json";
import en from "../i18n/en.json";

const {
  title = "Ruta Base",
  useVideoBg = false,
  bgImage = "/fondo.png",
} = Astro.props;

const switchTo = (targetLang) => {
  const next = new URL(Astro.url);
  if (targetLang === "en") next.searchParams.set("lang", "en");
  else next.searchParams.delete("lang");
  return `${next.pathname}${next.search}${next.hash}`;
};
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>

    <style>
      :root { font-family: system-ui, Arial; }
      html, body { height: 100%; }

      body{
        margin: 0;
        background: var(--bg) center/cover no-repeat fixed;
        position: relative;
        min-height: 100vh;
      }

      /* Si hay video en esta pagina, quitamos la imagen */
      body[data-video="1"]{
        background: none;
      }

      /* Video solo en Inicio cuando se active */
      #bg-video{
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
      }

      /* Capa blanca para legibilidad */
      body::before{
        content:"";
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.65);
        pointer-events: none;
        z-index: 0;
      }

      /* Barra morada estrecha */
      header{
        position: sticky;
        top: 0;
        z-index: 2;
        overflow: visible;
        display: flex;
        justify-content: center;
      }

      @keyframes headerFlow{
        0%{ background-position: 0% 50%; }
        50%{ background-position: 100% 50%; }
        100%{ background-position: 0% 50%; }
      }

      nav{
        height: 34px;
        display: inline-flex;
        gap: 8px;
        padding: 0 10px 0 0;
        overflow: visible;
        align-items: center;
        box-sizing: border-box;
        justify-content: center;
        position: relative;
        background: linear-gradient(120deg, rgba(210, 190, 255, 0.85), rgba(190, 170, 255, 0.75), rgba(225, 205, 255, 0.9));
        background-size: 220% 220%;
        border: 1px solid rgba(130, 100, 180, 0.25);
        border-radius: 14px;
        animation: headerFlow 10s ease-in-out infinite;
      }

      nav a{
        display: inline-block;
        text-decoration: none;
        color: #1a0b2e;
        padding: 0 12px;
        border-radius: 8px;
        white-space: nowrap;
        font-weight: 700;
        font-size: 16px;
        line-height: 34px;
      }

      .navHidden{
        display: none !important;
      }

      nav a:hover{
        background: rgba(255,255,255,0.35);
      }

      .langSwitch{
        display: inline-flex;
        gap: 4px;
        margin-left: 2px;
      }

      .langSwitch a{
        min-width: 30px;
        text-align: center;
        padding: 0 8px;
        font-size: 13px;
        font-weight: 800;
      }

      .langSwitch a.active{
        background: rgba(70, 46, 118, 0.22);
      }

      main{
        position: relative;
        z-index: 1;
        padding: 18px 14px;
        max-width: 1100px;
        margin: 0 auto;
      }

      .muted{ color:#666; font-size:14px; }
      .grid{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
      .card{ border:1px solid #eee; border-radius:14px; padding:14px; background: rgba(255,255,255,0.75); }
      .titleRow{
        display: block !important;
        position: relative !important;
        gap: 12px;
        flex-wrap: wrap;
        padding-top: 2px;
        width: 100%;
      }
      .titleNav{
        display: flex;
        gap: 8px;
        align-items: center;
        position: absolute !important;
        top: -10px !important;
        right: 0 !important;
        white-space: nowrap;
      }
      .titleNav a{
        text-decoration: none !important;
      }
      .titleArrow{
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        text-decoration: none !important;
        border-bottom: 0 !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        color: #1a0b2e;
        font-weight: 900;
        font-size: 34px !important;
        line-height: 1;
        border: 1px solid rgba(0,0,0,0.12);
        background: rgba(255,255,255,0.75);
        transform: scale(1.05);
      }
      .titleArrow:hover{
        background: rgba(155,120,255,0.18);
      }
      :global(.flag-badge){
        width: 1em;
        height: 1em;
        display: inline-block;
        border-radius: 3px;
        object-fit: cover;
        border: 1px solid rgba(0,0,0,0.15);
        background: var(--flag, #eaeaea);
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        vertical-align: -0.1em;
        margin-left: 6px;
      }
      :global(img.flag-badge){
        width: 1.6em;
        height: 1em;
        object-fit: contain;
        display: inline-block;
        background: transparent;
        border: 0;
        box-shadow: none;
      }
    </style>
  </head>

  <body data-video={useVideoBg ? "1" : "0"} style={`--bg: url('${bgImage}')`}>
    {useVideoBg && (
      <video id="bg-video" autoplay muted loop playsinline preload="auto">
        <source src="/fondo.mp4" type="video/mp4" />
      </video>
    )}

    <header>
      <nav>
        <a href="/" data-i18n="home">Inicio</a>
        <a href="/viajes" data-i18n="trips">Viajes</a>
        <a href="/mapas" data-i18n="maps">Mapa</a>
        <a href="/consejos" data-i18n="tips">Consejos</a>
        <a href="/galeria" data-i18n="gallery">Galería</a>
        <a href="/sobre" data-i18n="about">Sobre mí</a>
        <a href="/ev" class="navHidden" data-i18n="ev">EV</a>
        <a href="/msfs" class="navHidden" data-i18n="sim">Vuelo Virtual</a>
        <a href="/chat" class="navHidden" data-i18n="chat">Chat</a>
        <a href="/registro" class="navHidden" data-i18n="signup">Regístrate</a>
        <div class="langSwitch" aria-label="Language switch">
          <a href={switchTo("es")} data-lang-switch="es" class="active" aria-label="Cambiar a español">ES</a>
          <a href={switchTo("en")} data-lang-switch="en" aria-label="Switch to English">EN</a>
        </div>
      </nav>
    </header>

    <main>
      <slot />
    </main>

    <script is:inline define:vars={{ es, en }}>
      (() => {
        const ui = { es, en };
        const url = new URL(location.href);
        const queryLang = url.searchParams.get("lang");
        const savedLang = localStorage.getItem("rb_lang");
        const lang = queryLang === "en" || (queryLang !== "es" && savedLang === "en") ? "en" : "es";
        const isEnglish = lang === "en";

        localStorage.setItem("rb_lang", lang);
        document.documentElement.lang = lang;

        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (key && ui[lang][key]) el.textContent = ui[lang][key];
        });

        const switchLinks = Array.from(document.querySelectorAll("[data-lang-switch]"));
        switchLinks.forEach((link) => {
          const target = link.getAttribute("data-lang-switch");
          const next = new URL(location.href);
          if (target === "en") next.searchParams.set("lang", "en");
          else next.searchParams.delete("lang");
          link.setAttribute("href", `${next.pathname}${next.search}${next.hash}`);
          link.classList.toggle("active", target === lang);
          link.addEventListener("click", () => localStorage.setItem("rb_lang", target || "es"));
        });

        document.querySelectorAll('a[href^="/"]').forEach((a) => {
          if (a.hasAttribute("data-lang-switch")) return;
          const raw = a.getAttribute("href");
          if (!raw) return;
          const linkUrl = new URL(raw, location.origin);
          if (isEnglish) linkUrl.searchParams.set("lang", "en");
          else linkUrl.searchParams.delete("lang");
          a.setAttribute("href", `${linkUrl.pathname}${linkUrl.search}${linkUrl.hash}`);
        });
      })();
    </script>
  </body>
</html>
